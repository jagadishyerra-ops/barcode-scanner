<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phone Camera Barcode Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; text-align:center; padding:20px; background:#f0f0f0; }
    video { width:60%; max-width:250px; border:2px solid #333; border-radius:10px; margin-bottom:10px; }
    input, button, select { padding:10px; margin:5px; font-size:1rem; border-radius:5px; }
    #barcode { margin-top:20px; }
  </style>
</head>
<body>
<h1>ðŸ“· Serial# Barcode</h1>

  <button id="startBtn">Start Camera</button>
  <button id="stopBtn">Stop Camera</button><br>
  <video id="video" autoplay playsinline></video><br>

  <select id="facingSelect">
    <option value="environment">Rear Camera</option>
    <option value="user">Front Camera</option>
  </select>
  <button id="captureBtn">Capture & OCR</button><br>

  <input type="text" id="numberInput" placeholder="Detected or enter number"><br>
  <select id="formatSelect">
    <option value="CODE128">Code 128</option>
    <option value="EAN13">EAN-13</option>
    <option value="UPC">UPC</option>
    <option value="CODE39">Code 39</option>
  </select>
  <button id="generateBtn">Generate Barcode</button>
  <button id="clearBtn">Clear</button>
  <button id="downloadBtn">Download Barcode</button>

  <svg id="barcode"></svg>
  <canvas id="captureCanvas" style="display:none;"></canvas>
  <div id="ocrLog" style="margin-top:10px;"></div>

  <script src="https://unpkg.com/tesseract.js@4.1.4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const captureBtn = document.getElementById('captureBtn');
    const numberInput = document.getElementById('numberInput');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const barcodeEl = document.getElementById('barcode');
    const canvas = document.getElementById('captureCanvas');
    const facingSelect = document.getElementById('facingSelect');
    const ocrLog = document.getElementById('ocrLog');

    let stream = null;

    // Start camera
    startBtn.onclick = async () => {
      if (stream) return;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facingSelect.value } });
        video.srcObject = stream;
        await video.play();
      } catch (e) {
        alert('Camera error: ' + e.message);
      }
    };

    // Stop camera
    stopBtn.onclick = () => {
      if (!stream) return;
      stream.getTracks().forEach(track => track.stop());
      video.srcObject = null;
      stream = null;
    };

    // OCR capture
    captureBtn.onclick = async () => {
      if (!stream) return alert('Camera not started');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      ocrLog.textContent = 'Running OCR...';
      ocrLog.style.color = 'black';
      try {
        const { data } = await Tesseract.recognize(canvas, 'eng');
        const matches = data.text.match(/\b215[0-9]{5}\b/g) || [];
        if (matches.length > 0) {
          numberInput.value = matches[0];
          ocrLog.textContent = 'âœ… Valid number detected!';
          ocrLog.style.color = 'green';
          generateBarcode(numberInput.value);
        } else {
          numberInput.value = '';
          barcodeEl.innerHTML = '';
          ocrLog.textContent = 'âŒ No valid 8-digit number starting with 215 found';
          ocrLog.style.color = 'red';
        }
      } catch (e) {
        ocrLog.textContent = 'OCR failed: ' + e.message;
        ocrLog.style.color = 'red';
      }
    };

    // Generate barcode function
    function generateBarcode(number) {
      JsBarcode(barcodeEl, number, {
        format: document.getElementById('formatSelect').value,
        displayValue: true,
        fontSize: 18,
        width: 2,
        height: 80,
        margin: 8
      });
    }

    // Manual generate button
    generateBtn.onclick = () => {
      const val = numberInput.value;
      if (!/^215\d{5}$/.test(val)) {
        return alert('Number must start with 215 and be 8 digits long');
      }
      generateBarcode(val);
    };

    // Clear button
    clearBtn.onclick = () => {
      numberInput.value = '';
      barcodeEl.innerHTML = '';
      ocrLog.textContent = '';
    };

    // Download barcode button
    downloadBtn.onclick = () => {
      if (!barcodeEl.innerHTML) return alert('No barcode to download');
      const svgData = new XMLSerializer().serializeToString(barcodeEl);
      const canvasEl = document.createElement('canvas');
      const ctx = canvasEl.getContext('2d');
      const img = new Image();
      const svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(svgBlob);
      img.onload = function() {
        canvasEl.width = img.width;
        canvasEl.height = img.height;
        ctx.drawImage(img, 0, 0);
        URL.revokeObjectURL(url);
        const pngUrl = canvasEl.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = pngUrl;
        a.download = numberInput.value + ".png";
        a.click();
      }
      img.src = url;
    };
  </script>
</body>
</html>


