<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phone Camera Barcode Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; text-align:center; padding:20px; background:#f0f0f0; }
    video { width:90%; max-width:400px; border:2px solid #333; border-radius:10px; }
    input, button, select { padding:10px; margin:5px; font-size:1rem; border-radius:5px; }
    #barcode { margin-top:20px; }
  </style>
</head>
<body>
  <h1>ðŸ“· Phone Camera Barcode Scanner & Generator</h1>

  <video id="video" autoplay playsinline></video><br>

  <select id="facingSelect">
    <option value="environment">Rear Camera</option>
    <option value="user">Front Camera</option>
  </select>
  <button id="startBtn">Start Camera</button>
  <button id="stopBtn">Stop Camera</button>
  <button id="captureBtn">Capture & OCR</button><br>

  <input type="text" id="numberInput" placeholder="Detected or enter number"><br>
  <select id="formatSelect">
    <option value="CODE128">Code 128</option>
    <option value="EAN13">EAN-13</option>
    <option value="UPC">UPC</option>
    <option value="CODE39">Code 39</option>
  </select>
  <button id="generateBtn">Generate Barcode</button>

  <svg id="barcode"></svg>
  <canvas id="captureCanvas" style="display:none;"></canvas>
  <div id="ocrLog" style="margin-top:10px;"></div>

  <script src="https://unpkg.com/tesseract.js@4.1.4/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const captureBtn = document.getElementById('captureBtn');
    const numberInput = document.getElementById('numberInput');
    const generateBtn = document.getElementById('generateBtn');
    const barcodeEl = document.getElementById('barcode');
    const canvas = document.getElementById('captureCanvas');
    const facingSelect = document.getElementById('facingSelect');
    const ocrLog = document.getElementById('ocrLog');

    let stream = null;

    startBtn.onclick = async () => {
      if (stream) return;
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facingSelect.value } });
        video.srcObject = stream;
      } catch (e) {
        alert('Camera error: ' + e.message);
      }
    };

    stopBtn.onclick = () => {
      if (!stream) return;
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      video.srcObject = null;
    };

captureBtn.onclick = async () => {
  if (!stream) return alert('Start camera first!');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  ocrLog.textContent = 'Running OCR...';
  try {
    const { data } = await Tesseract.recognize(canvas, 'eng');
    // Match numbers starting with 215 and 8 digits long
    const matches = data.text.match(/\b215[0-9]{5}\b/g) || [];
    if (matches.length > 0) {
      numberInput.value = matches[0]; // pick the first valid match
      ocrLog.textContent = 'OCR complete: Found valid number';
      
      // Automatically generate the barcode
      JsBarcode(barcodeEl, numberInput.value, {
        format: document.getElementById('formatSelect').value,
        displayValue: true,
        fontSize: 18,
        width: 2,
        height: 80,
        margin: 8
      });
      
    } else {
      numberInput.value = '';
      barcodeEl.innerHTML = ''; // clear barcode if no valid number
      ocrLog.textContent = 'OCR complete: No valid 8-digit number starting with 215 found';
    }
  } catch (e) {
    ocrLog.textContent = 'OCR failed: ' + e.message;
  }
};

// Optional: still allow manual generate button if user types a number
generateBtn.onclick = () => {
  if (!numberInput.value) return alert('Enter or scan a valid number first');
  // Only generate if it starts with 215 and is 8 digits
  if (!/^215\d{5}$/.test(numberInput.value)) {
    return alert('Number must start with 215 and be 8 digits long');
  }
  JsBarcode(barcodeEl, numberInput.value, {
    format: document.getElementById('formatSelect').value,
    displayValue: true,
    fontSize: 18,
    width: 2,
    height: 80,
    margin: 8
  });
};
  </script>
</body>
</html>
